import { NextRequest, NextResponse } from 'next/server'
import { createClient } from '@/lib/supabase'
import { NICHES, COLOR_THEMES } from '@/lib/landing-pages-constants'
import OpenAI from 'openai'

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
})

interface GenerateRequest {
  niche: string
  problem: string
  solution: string
  cta_text: string
  theme_color: string
}

export async function POST(req: NextRequest) {
  try {
    const body: GenerateRequest = await req.json()
    const { niche, problem, solution, cta_text, theme_color } = body

    // Valida√ß√£o
    if (!niche || !problem || !solution || !cta_text || !theme_color) {
      return NextResponse.json(
        { error: 'Todos os campos s√£o obrigat√≥rios' },
        { status: 400 }
      )
    }

    // Buscar configura√ß√£o de tema
    const theme = COLOR_THEMES[theme_color as keyof typeof COLOR_THEMES]
    if (!theme) {
      return NextResponse.json(
        { error: 'Tema de cor inv√°lido' },
        { status: 400 }
      )
    }

    // 1. Gerar conte√∫do com GPT-4
    console.log('ü§ñ Gerando conte√∫do com GPT-4...')
    const contentResponse = await openai.chat.completions.create({
      model: 'gpt-4o',
      messages: [
        {
          role: 'system',
          content: `Voc√™ √© um especialista em copywriting para landing pages de convers√£o.
Crie conte√∫do persuasivo e profissional para capturar leads qualificados.
Retorne APENAS um JSON v√°lido sem markdown, sem coment√°rios, sem quebras de linha dentro das strings.`
        },
        {
          role: 'user',
          content: `Crie uma landing page para:
- Nicho: ${niche}
- Problema: ${problem}
- Solu√ß√£o: ${solution}
- CTA: ${cta_text}

Retorne um JSON com:
{
  "headline": "T√≠tulo principal impactante (m√°x 60 caracteres)",
  "subheadline": "Subt√≠tulo complementar (m√°x 120 caracteres)",
  "benefits": ["benef√≠cio 1", "benef√≠cio 2", "benef√≠cio 3", "benef√≠cio 4"],
  "social_proof": "Texto de prova social",
  "urgency": "Texto de urg√™ncia/escassez",
  "image_prompt": "Prompt FOTOGR√ÅFICO ULTRA-DETALHADO para DALL-E 3. Descreva uma cena FOTORREALISTA de revista de publicidade profissional relacionada ao nicho. SE INCLUIR PESSOAS: especifique que devem ser fotografias reais de modelos humanos, com textura de pele natural, express√µes aut√™nticas, ilumina√ß√£o de est√∫dio profissional. PROIBIDO: ilustra√ß√µes, cartoons, 3D, arte digital, anime. CR√çTICO: ZERO texto, palavras, letras, n√∫meros, logos ou tipografia na imagem. Apenas fotografia pura estilo editorial comercial."
}`
        }
      ],
      temperature: 0.8,
    })

    const contentText = contentResponse.choices[0].message.content || '{}'
    const content = JSON.parse(contentText)

    // 2. Gerar imagem com DALL-E 3
    console.log('üé® Gerando imagem com DALL-E 3...')
    const imageResponse = await openai.images.generate({
      model: 'dall-e-3',
      prompt: `PROFESSIONAL PHOTOGRAPHER STYLE - REAL PHOTO WITH SUBTLE EDITING:

${content.image_prompt}

üì∏ PHOTOGRAPHY APPROACH:
This is a REAL photograph taken by a professional photographer and lightly edited in Lightroom/Photoshop.
Think: Corporate headshots, wedding photography, lifestyle editorial, commercial portrait work.

CAMERA & TECHNICAL SPECS:
üì∑ Camera: Canon EOS R6 / Nikon Z6 / Sony A7III (professional mirrorless)
üîç Lens: 85mm f/1.8 or 50mm f/1.4 prime lens (natural bokeh)
‚ö° Lighting: Natural window light + reflector OR 1-2 softbox setup (soft, flattering)
üé¨ Settings: ISO 400-800, f/2.8-f/4, slight grain from real sensor
üìê Composition: Rule of thirds, natural eye contact, professional framing

POST-PRODUCTION (SUBTLE PROFESSIONAL EDITING):
‚ú® Color grading: Warm/cool shift (¬±5%), subtle lift in shadows
‚ú® Skin retouching: Light frequency separation (keep texture, remove only major blemishes)
‚ú® Exposure: +0.3 to +0.7 stop lift, gentle highlight recovery
‚ú® Sharpening: Selective (eyes sharp, background soft)
‚ú® Contrast: Mild S-curve for depth
‚ú® Clarity: +10 to +20 (NOT overdone)
‚ö†Ô∏è CRITICAL: Editing is SUBTLE - still looks natural, not Instagram filtered

REAL HUMAN CHARACTERISTICS:
‚úÖ Authentic people: Real models/subjects with natural features
‚úÖ Skin: Visible pores and texture (retouched but NOT airbrushed smooth)
‚úÖ Eyes: Natural catchlights from real light source, slight asymmetry
‚úÖ Hair: Professional styling but with natural flyaways and texture
‚úÖ Expression: Genuine smiles (crow's feet visible), relaxed faces
‚úÖ Posing: Professional direction but natural body language
‚úÖ Wardrobe: Business casual, corporate, or lifestyle clothing (real fabric)
‚úÖ Diversity: Age 25-45, various ethnicities, realistic representation

ENVIRONMENT:
‚úÖ Professional settings: Modern office, coffee shop, outdoor corporate campus
‚úÖ Natural clutter: Laptop, phone, coffee mug, plants (lived-in spaces)
‚úÖ Bokeh: Natural lens blur (f/1.8-f/2.8), NOT perfect circular bokeh
‚úÖ Lighting: One dominant source (window/softbox) + natural fill
‚úÖ Depth: Foreground/background elements slightly out of focus

‚ùå ABSOLUTELY FORBIDDEN:
‚ùå CGI, 3D renders, digital art, AI-generated uncanny valley faces
‚ùå Overly smooth skin (plastic/waxy look)
‚ùå Perfect symmetry (faces, environments, objects)
‚ùå Video game lighting (rim glow, gradient fill, ambient occlusion look)
‚ùå Heavy filters (over-saturated, HDR tone-mapped, Instagram presets)
‚ùå Stock photo clich√©s (pointing at laptops, fake laughter)
‚ùå Text, logos, watermarks, graphics, typography

üéØ REFERENCE PHOTOGRAPHERS:
- Peter Hurley (corporate headshots - natural but polished)
- Annie Leibovitz (editorial portraits - authentic with flair)
- Jos√© Villa (lifestyle photography - warm, natural light)
- Sue Bryce (glamour portraits - flattering but real)

VIBE: "This person hired a professional photographer for LinkedIn/company website photos"
NOT: "This is a 3D character from a Pixar movie" or "AI generated synthetic human"

Context: ${niche} industry, professional business photography.`,
      size: '1792x1024',
      quality: 'hd',
      n: 1,
    })

    const heroImageUrl = imageResponse.data?.[0]?.url || ''

    // 3. Gerar HTML completo
    console.log('üìÑ Gerando HTML completo...')
    const htmlResponse = await openai.chat.completions.create({
      model: 'gpt-4o',
      messages: [
        {
          role: 'system',
          content: `Voc√™ √© um desenvolvedor front-end especialista em criar landing pages de alta convers√£o.
Voc√™ DEVE retornar APENAS HTML puro, sem markdown, sem \`\`\`html, sem explica√ß√µes.
Preencha o template fornecido substituindo os marcadores [CONTE√öDO] pelo texto apropriado.
IMPORTANTE: Retorne HTML direto, n√£o envolva em blocos de c√≥digo markdown.`
        },
        {
          role: 'user',
          content: `Preencha os marcadores [CONTE√öDO] neste template. Retorne APENAS o HTML final, sem \`\`\`html:

<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>[HEADLINE]</title>
  <meta name="description" content="[SUBHEADLINE]">
  <meta property="og:title" content="[HEADLINE]">
  <meta property="og:description" content="[SUBHEADLINE]">
  <meta property="og:image" content="${heroImageUrl}">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #ffffff;
      color: #1e293b;
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
    }
    
    /* Header SEO - Oculto visualmente */
    header {
      position: absolute;
      left: -9999px;
      width: 1px;
      height: 1px;
      overflow: hidden;
    }
    
    /* Hero Section - Design Profissional */
    .hero {
      min-height: 90vh;
      display: flex;
      align-items: center;
      background: #f8fafc;
      padding: 4rem 2rem 3rem;
      position: relative;
    }
    .hero-container {
      max-width: 1280px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1.2fr 1fr;
      gap: 5rem;
      align-items: center;
    }
    
    /* Badge Nicho */
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: ${theme.primary}15;
      color: ${theme.primary};
      border-radius: 50px;
      font-size: 0.875rem;
      font-weight: 600;
      margin-bottom: 1.5rem;
    }
    
    .hero-content h1 {
      font-size: 3.5rem;
      font-weight: 800;
      color: #0f172a;
      margin-bottom: 1.5rem;
      line-height: 1.1;
      letter-spacing: -0.02em;
    }
    .hero-content h1 span {
      color: ${theme.primary};
    }
    .hero-content p {
      font-size: 1.25rem;
      color: #475569;
      margin-bottom: 2.5rem;
      line-height: 1.7;
    }
    
    /* Stats */
    .stats {
      display: flex;
      gap: 3rem;
      margin-top: 3rem;
      padding-top: 2rem;
      border-top: 1px solid #e2e8f0;
    }
    .stat-item {
      display: flex;
      flex-direction: column;
    }
    .stat-number {
      font-size: 2rem;
      font-weight: 800;
      color: ${theme.primary};
      line-height: 1;
      margin-bottom: 0.25rem;
    }
    .stat-label {
      font-size: 0.875rem;
      color: #64748b;
      font-weight: 500;
    }
    
    /* Hero Image */
    .hero-image {
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 20px 60px -15px rgba(0,0,0,0.15);
      position: relative;
    }
    .hero-image img {
      width: 100%;
      height: auto;
      display: block;
    }
    
    /* Floating badge na imagem */
    .image-badge {
      position: absolute;
      bottom: 2rem;
      left: 2rem;
      background: white;
      padding: 1rem 1.5rem;
      border-radius: 12px;
      box-shadow: 0 10px 30px -10px rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    .image-badge-icon {
      width: 48px;
      height: 48px;
      background: ${theme.primary}15;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
    }
    .image-badge-text h4 {
      font-size: 1.5rem;
      font-weight: 700;
      color: #0f172a;
      line-height: 1;
    }
    .image-badge-text p {
      font-size: 0.875rem;
      color: #64748b;
    }
    
    /* CTA Buttons */
    .cta-group {
      display: flex;
      gap: 1rem;
      align-items: center;
    }
    .cta-button {
      display: inline-flex;
      align-items: center;
      gap: 0.75rem;
      padding: 1rem 2rem;
      font-size: 1.125rem;
      font-weight: 600;
      color: #ffffff;
      background: ${theme.primary};
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 4px 12px ${theme.primary}40;
      text-decoration: none;
    }
    .cta-button:hover {
      background: ${theme.primary};
      filter: brightness(1.1);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px ${theme.primary}50;
    }
    .cta-secondary {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 1rem 1.5rem;
      font-size: 1rem;
      font-weight: 600;
      color: #64748b;
      background: transparent;
      border: none;
      cursor: pointer;
      text-decoration: none;
    }
    
    /* Benefits Section */
    .benefits {
      padding: 6rem 2rem;
      background: white;
    }
    .benefits-container {
      max-width: 1280px;
      margin: 0 auto;
    }
    .section-header {
      text-align: center;
      max-width: 700px;
      margin: 0 auto 4rem;
    }
    .section-badge {
      display: inline-block;
      padding: 0.5rem 1rem;
      background: ${theme.primary}10;
      color: ${theme.primary};
      border-radius: 50px;
      font-size: 0.875rem;
      font-weight: 600;
      margin-bottom: 1rem;
    }
    .section-header h2 {
      font-size: 2.5rem;
      font-weight: 800;
      color: #0f172a;
      margin-bottom: 1rem;
      letter-spacing: -0.02em;
    }
    .section-header p {
      font-size: 1.125rem;
      color: #64748b;
    }
    
    .benefits-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 2rem;
    }
    .benefit-card {
      padding: 2rem;
      background: #f8fafc;
      border-radius: 16px;
      border: 1px solid #e2e8f0;
      transition: all 0.3s;
    }
    .benefit-card:hover {
      border-color: ${theme.primary};
      box-shadow: 0 10px 30px -10px ${theme.primary}20;
      transform: translateY(-4px);
    }
    .benefit-icon {
      width: 56px;
      height: 56px;
      background: white;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.75rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    .benefit-card h3 {
      font-size: 1.25rem;
      font-weight: 700;
      color: #0f172a;
      margin-bottom: 0.75rem;
    }
    .benefit-card p {
      color: #64748b;
      line-height: 1.7;
    }
    
    /* How it Works */
    .how-it-works {
      padding: 6rem 2rem;
      background: #f8fafc;
    }
    .steps-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 3rem;
      max-width: 1280px;
      margin: 4rem auto 0;
    }
    .step-card {
      text-align: center;
      position: relative;
    }
    .step-number {
      width: 64px;
      height: 64px;
      background: ${theme.primary};
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.75rem;
      font-weight: 800;
      margin: 0 auto 1.5rem;
      box-shadow: 0 8px 20px ${theme.primary}40;
    }
    .step-card h3 {
      font-size: 1.5rem;
      font-weight: 700;
      color: #0f172a;
      margin-bottom: 0.75rem;
    }
    .step-card p {
      color: #64748b;
      line-height: 1.7;
    }
    
    /* CTA Section */
    .cta-section {
      padding: 6rem 2rem;
      background: #0f172a;
      text-align: center;
      color: white;
    }
    .cta-section-content {
      max-width: 800px;
      margin: 0 auto;
    }
    .cta-section h2 {
      font-size: 3rem;
      font-weight: 800;
      margin-bottom: 1.5rem;
      letter-spacing: -0.02em;
    }
    .cta-section p {
      font-size: 1.25rem;
      color: #cbd5e1;
      margin-bottom: 2.5rem;
    }
    .cta-section .cta-button {
      background: ${theme.primary};
      font-size: 1.25rem;
      padding: 1.25rem 2.5rem;
    }
    
    /* Footer */
    .footer {
      padding: 2rem;
      text-align: center;
      background: #ffffff;
      border-top: 1px solid #e2e8f0;
    }
    .footer p {
      color: #94a3b8;
      font-size: 0.875rem;
    }
    .footer a {
      color: ${theme.primary};
      text-decoration: none;
      font-weight: 600;
    }
    
    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(15, 23, 42, 0.8);
      z-index: 9999;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      backdrop-filter: blur(8px);
    }
    .modal.active {
      display: flex;
    }
    .modal-content {
      background: white;
      border-radius: 24px;
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
      box-shadow: 0 25px 60px -15px rgba(0,0,0,0.4);
    }
    .modal-close {
      position: absolute;
      top: 1.5rem;
      right: 1.5rem;
      background: #f1f5f9;
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      font-size: 1.5rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .modal-close:hover {
      background: #e2e8f0;
    }
    
    /* E-book Banner no Modal */
    .ebook-banner {
      background: linear-gradient(135deg, ${theme.primary} 0%, ${theme.secondary || theme.primary} 100%);
      color: white;
      padding: 2.5rem;
      text-align: center;
      border-radius: 24px 24px 0 0;
    }
    .ebook-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
      display: block;
    }
    .ebook-banner h3 {
      font-size: 1.75rem;
      font-weight: 800;
      margin-bottom: 0.5rem;
    }
    .ebook-banner p {
      font-size: 1rem;
      opacity: 0.95;
    }
    
    .modal-body {
      padding: 2.5rem;
    }
    .modal-body h2 {
      font-size: 1.75rem;
      font-weight: 800;
      color: #0f172a;
      margin-bottom: 1rem;
    }
    .modal-body > p {
      color: #64748b;
      margin-bottom: 2rem;
    }
    
    .form-group {
      margin-bottom: 1.5rem;
    }
    .form-group label {
      display: block;
      font-weight: 600;
      color: #334155;
      margin-bottom: 0.5rem;
      font-size: 0.875rem;
    }
    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 0.875rem 1rem;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      font-size: 1rem;
      font-family: inherit;
      transition: all 0.2s;
    }
    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: ${theme.primary};
      box-shadow: 0 0 0 3px ${theme.primary}15;
    }
    .form-group textarea {
      resize: vertical;
      min-height: 120px;
    }
    .submit-button {
      width: 100%;
      padding: 1.125rem;
      background: ${theme.primary};
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 1.125rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 4px 12px ${theme.primary}40;
    }
    .submit-button:hover {
      filter: brightness(1.1);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px ${theme.primary}50;
    }
    .submit-button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    /* Success Message */
    .success-message {
      display: none;
      text-align: center;
      padding: 3rem 2rem;
    }
    .success-message.active {
      display: block;
    }
    .success-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
    }
    .success-message h3 {
      font-size: 2rem;
      font-weight: 800;
      color: #0f172a;
      margin-bottom: 1rem;
    }
    .success-message p {
      color: #64748b;
      font-size: 1.125rem;
      line-height: 1.7;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .hero-container {
        grid-template-columns: 1fr;
        gap: 3rem;
      }
      .hero-content h1 {
        font-size: 2.5rem;
      }
      .stats {
        gap: 2rem;
      }
      .steps-grid {
        grid-template-columns: 1fr;
        gap: 2rem;
      }
      .cta-group {
        flex-direction: column;
      }
      .cta-section h2 {
        font-size: 2rem;
      }
    }
  </style>
</head>
<body>
  <!-- Header SEO -->
  <header>
    <h1>[HEADLINE]</h1>
    <nav>
      <a href="/">In√≠cio</a>
      <a href="#beneficios">Benef√≠cios</a>
      <a href="#como-funciona">Como Funciona</a>
    </nav>
  </header>

  <!-- Hero Section -->
  <section class="hero">
    <div class="hero-container">
      <div class="hero-content">
        <span class="badge">üéØ [NICHO]</span>
        <h1>[HEADLINE_COM_SPAN]</h1>
        <p>[SUBHEADLINE]</p>
        
        <div class="cta-group">
          <button class="cta-button" onclick="openModal()">
            üéÅ [CTA_TEXT]
          </button>
          <a href="#como-funciona" class="cta-secondary">
            Ver Demonstra√ß√£o ‚Üí
          </a>
        </div>
        
        <div class="stats">
          <div class="stat-item">
            <div class="stat-number">[STAT_1_NUMBER]</div>
            <div class="stat-label">[STAT_1_LABEL]</div>
          </div>
          <div class="stat-item">
            <div class="stat-number">[STAT_2_NUMBER]</div>
            <div class="stat-label">[STAT_2_LABEL]</div>
          </div>
          <div class="stat-item">
            <div class="stat-number">[STAT_3_NUMBER]</div>
            <div class="stat-label">[STAT_3_LABEL]</div>
          </div>
        </div>
      </div>
      
      <div class="hero-image">
        <img src="${heroImageUrl}" alt="[HEADLINE]">
        <div class="image-badge">
          <div class="image-badge-icon">[BADGE_ICON]</div>
          <div class="image-badge-text">
            <h4>[BADGE_NUMBER]</h4>
            <p>[BADGE_LABEL]</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Benefits Section -->
  <section class="benefits" id="beneficios">
    <div class="benefits-container">
      <div class="section-header">
        <span class="section-badge">Por que escolher nossa solu√ß√£o?</span>
        <h2>Tudo que voc√™ precisa em uma √∫nica plataforma</h2>
        <p>Recursos poderosos que simplificam sua rotina e melhoram seus resultados.</p>
      </div>
      
      <div class="benefits-grid">
        [BENEFITS_CARDS]
      </div>
    </div>
  </section>

  <!-- How It Works -->
  <section class="how-it-works" id="como-funciona">
    <div class="benefits-container">
      <div class="section-header">
        <span class="section-badge">Como funciona?</span>
        <h2>Em 3 passos simples voc√™ est√° pronto para come√ßar</h2>
      </div>
      
      <div class="steps-grid">
        <div class="step-card">
          <div class="step-number">1</div>
          <h3>[STEP_1_TITLE]</h3>
          <p>[STEP_1_DESC]</p>
        </div>
        <div class="step-card">
          <div class="step-number">2</div>
          <h3>[STEP_2_TITLE]</h3>
          <p>[STEP_2_DESC]</p>
        </div>
        <div class="step-card">
          <div class="step-number">3</div>
          <h3>[STEP_3_TITLE]</h3>
          <p>[STEP_3_DESC]</p>
        </div>
      </div>
    </div>
  </section>

  <!-- CTA Final -->
  <section class="cta-section">
    <div class="cta-section-content">
      <h2>Pronto para modernizar [AREA_ATUACAO]?</h2>
      <p>Junte-se a milhares de profissionais que j√° transformaram seus resultados com nossa solu√ß√£o.</p>
      <button class="cta-button" onclick="openModal()">
        üéÅ Baixar E-book Gr√°tis + Agendar uma demonstra√ß√£o gratuita agora
      </button>
    </div>
  </section>

  <!-- Footer -->
  <footer class="footer">
    <p>powered by <a href="https://catbytes.site">CATBytes AI</a></p>
  </footer>

  <!-- Modal Form -->
  <div class="modal" id="leadModal">
    <div class="modal-content">
      <button class="modal-close" onclick="closeModal()">√ó</button>
      
      <div class="ebook-banner">
        <span class="ebook-icon">üéÅ</span>
        <h3>B√¥nus Exclusivo!</h3>
        <p>Receba gratuitamente nosso e-book "100 Dicas de Presen√ßa Online"</p>
      </div>
      
      <div class="modal-body">
        <div id="formContainer">
          <h2>[CTA_TEXT]</h2>
          <p>Preencha o formul√°rio abaixo e receba o e-book + informa√ß√µes sobre [SOLUCAO]</p>
          
          <form id="leadForm" onsubmit="submitForm(event)">
            <input type="hidden" name="hp" id="hp" value="">
            
            <div class="form-group">
              <label>Nome Completo</label>
              <input type="text" name="name" required placeholder="Digite seu nome">
            </div>
            
            <div class="form-group">
              <label>E-mail (enviaremos o e-book aqui)</label>
              <input type="email" name="email" required placeholder="seu@email.com">
            </div>
            
            <div class="form-group">
              <label>Telefone/WhatsApp</label>
              <input type="tel" name="phone" required placeholder="(00) 00000-0000">
            </div>
            
            <div class="form-group">
              <label>Como podemos ajudar?</label>
              <textarea name="message" placeholder="Conte-nos sobre sua necessidade..." required></textarea>
            </div>
            
            <button type="submit" class="submit-button" id="submitBtn">
              üéÅ Receber E-book Gr√°tis + Contato
            </button>
          </form>
        </div>
        
        <div class="success-message" id="successMessage">
          <span class="success-icon">‚úÖ</span>
          <h3>Sucesso!</h3>
          <p><strong>Verifique seu email para receber:</strong><br><br>
          üìö E-book "100 Dicas de Presen√ßa Online"<br>
          üìã Informa√ß√µes sobre [SOLUCAO]<br><br>
          Nossa equipe entrar√° em contato em breve!</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    function openModal() {
      document.getElementById('leadModal').classList.add('active');
      document.body.style.overflow = 'hidden';
    }
    
    function closeModal() {
      document.getElementById('leadModal').classList.remove('active');
      document.body.style.overflow = 'auto';
    }
    
    // Fechar modal ao clicar fora
    document.getElementById('leadModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeModal();
      }
    });
    
    async function submitForm(e) {
      e.preventDefault();
      
      const submitBtn = document.getElementById('submitBtn');
      const originalText = submitBtn.textContent;
      submitBtn.textContent = 'Enviando...';
      submitBtn.disabled = true;
      
      const formData = new FormData(e.target);
      const data = {
        name: formData.get('name'),
        email: formData.get('email'),
        phone: formData.get('phone'),
        message: formData.get('message'),
        hp: formData.get('hp'),
        slug: window.location.pathname.split('/').pop()
      };
      
      try {
        const response = await fetch('/api/landing-pages/submit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        if (response.ok) {
          document.getElementById('formContainer').style.display = 'none';
          document.getElementById('successMessage').classList.add('active');
        } else {
          alert('Erro ao enviar. Tente novamente.');
          submitBtn.textContent = originalText;
          submitBtn.disabled = false;
        }
      } catch (error) {
        alert('Erro ao enviar. Tente novamente.');
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
      }
    }
  </script>
</body>
</html>

INSTRU√á√ïES DE PREENCHIMENTO:
Substitua TODOS os marcadores [CONTE√öDO] pelos valores apropriados baseados nestas informa√ß√µes:

Nicho: ${niche}
Problema: ${problem}
Solu√ß√£o: ${solution}
CTA: ${cta_text}
Headline: ${content.headline}
Subheadline: ${content.subheadline}
Benefits: ${content.benefits.join(', ')}

MARCADORES PARA PREENCHER:
- [HEADLINE]: ${content.headline}
- [SUBHEADLINE]: ${content.subheadline}
- [NICHO]: Capitalize "${niche}"
- [HEADLINE_COM_SPAN]: Divida o headline em 2 partes, coloque a segunda parte dentro de <span>${content.headline}</span>
- [CTA_TEXT]: Baixar E-book Gr√°tis + ${cta_text}
- [STAT_1_NUMBER], [STAT_1_LABEL]: Crie estat√≠sticas impressionantes relacionadas ao nicho (ex: "15k+", "Usu√°rios ativos")
- [STAT_2_NUMBER], [STAT_2_LABEL]: Outra estat√≠stica
- [STAT_3_NUMBER], [STAT_3_LABEL]: Terceira estat√≠stica
- [BADGE_ICON]: Emoji relacionado ao nicho
- [BADGE_NUMBER]: N√∫mero grande (ex: "248", "4.9/5")
- [BADGE_LABEL]: Label do badge (ex: "Clientes satisfeitos", "Avalia√ß√£o")
- [BENEFITS_CARDS]: Crie 4-6 benefit cards usando o formato:
  <div class="benefit-card">
    <div class="benefit-icon">üöÄ</div>
    <h3>T√≠tulo do Benef√≠cio</h3>
    <p>Descri√ß√£o clara e objetiva do benef√≠cio em 1-2 linhas.</p>
  </div>
- [STEP_1_TITLE], [STEP_1_DESC]: Passo 1 do processo
- [STEP_2_TITLE], [STEP_2_DESC]: Passo 2 do processo
- [STEP_3_TITLE], [STEP_3_DESC]: Passo 3 do processo
- [AREA_ATUACAO]: √Årea de atua√ß√£o (ex: "seu consult√≥rio", "sua empresa")
- [SOLUCAO]: ${solution}

IMPORTANTE: 
1. Retorne APENAS o HTML final completo
2. N√ÉO envolva em blocos markdown (\`\`\`html)
3. N√ÉO adicione explica√ß√µes antes ou depois
4. Comece direto com <!DOCTYPE html>`
        }
      ],
      temperature: 0.7,
    })

    let htmlContent = htmlResponse.choices[0].message.content || ''
    
    // Remover markdown se o GPT insistir em adicionar
    htmlContent = htmlContent.replace(/^```html\n?/i, '').replace(/\n?```$/i, '').trim()
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 2.5rem;
    }
    .benefit-card {
      background: white;
      padding: 2.5rem;
      border-radius: 15px;
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
      transition: transform 0.3s;
    }
    .benefit-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 15px -3px rgba(0,0,0,0.15);
    }
    .benefit-icon {
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, ${theme.primary} 0%, ${theme.secondary} 100%);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      margin-bottom: 1.5rem;
    }
    .benefit-card h3 {
      font-size: 1.5rem;
      margin-bottom: 1rem;
      color: #2d3748;
    }
    .benefit-card p {
      color: #4a5568;
      line-height: 1.7;
    }
    
    /* Social Proof */
    .social-proof {
      padding: 4rem 2rem;
      background: linear-gradient(135deg, ${theme.primary} 0%, ${theme.secondary} 100%);
      text-align: center;
      color: white;
    }
    .social-proof h3 {
      font-size: 2rem;
      margin-bottom: 1rem;
    }
    .social-proof p {
      font-size: 1.25rem;
      opacity: 0.95;
    }
    
    /* Footer */
    footer {
      padding: 2rem;
      background: #1a202c;
      text-align: center;
    }
    footer img {
      height: 40px;
      opacity: 0.7;
      margin-bottom: 0.5rem;
    }
    footer p {
      color: #a0aec0;
      font-size: 0.9rem;
    }
    
    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      z-index: 9999;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    }
    .modal.active {
      display: flex;
    }
    .modal-content {
      background: white;
      padding: 3rem;
      border-radius: 20px;
      max-width: 500px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
    }
    .modal-close {
      position: absolute;
      top: 1.5rem;
      right: 1.5rem;
      font-size: 2rem;
      cursor: pointer;
      color: #718096;
      background: none;
      border: none;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.3s;
    }
    .modal-close:hover {
      background: #f7fafc;
      color: #1a202c;
    }
    .modal h2 {
      font-size: 2rem;
      margin-bottom: 1rem;
      color: #1a202c;
    }
    .modal p {
      color: #4a5568;
      margin-bottom: 2rem;
    }
    form label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: #2d3748;
      font-size: 0.95rem;
    }
    form input, form textarea {
      width: 100%;
      padding: 0.875rem 1rem;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      font-size: 1rem;
      margin-bottom: 1.25rem;
      transition: border 0.3s;
      background: #ffffff;
      color: #1a202c;
    }
    form input:focus, form textarea:focus {
      outline: none;
      border-color: ${theme.primary};
    }
    form input::placeholder, form textarea::placeholder {
      color: #a0aec0;
    }
    form textarea {
      resize: vertical;
      min-height: 120px;
    }
    form button {
      width: 100%;
      padding: 1rem;
      background: linear-gradient(135deg, ${theme.primary} 0%, ${theme.secondary} 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 1.125rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
    }
    form button:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px -5px rgba(0,0,0,0.3);
    }
    .security-badge {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      margin-top: 1rem;
      color: #718096;
      font-size: 0.875rem;
    }
    .honeypot {
      position: absolute;
      left: -9999px;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .hero-container {
        grid-template-columns: 1fr;
        gap: 2rem;
      }
      .hero-content h1 {
        font-size: 2.5rem;
      }
      .hero-content p {
        font-size: 1.25rem;
      }
      .benefits h2 {
        font-size: 2rem;
      }
      .modal-content {
        padding: 2rem;
      }
    }
  </style>
</head>
<body>
  <!-- Header SEO (visualmente oculto) -->
  <header>
    <img src="https://catbytes.site/images/logo-desenvolvedora.webp" alt="[HEADLINE] - powered by CATBytes AI">
  </header>

  <!-- Hero Section -->
  <section class="hero">
    <div class="hero-container">
      <div class="hero-content">
        <h1>[HEADLINE]</h1>
        <p>[SUBHEADLINE]</p>
        <button class="cta-button" onclick="openModal()">[CTA_TEXT]</button>
      </div>
      <div class="hero-image">
        <img src="${heroImageUrl}" alt="[HEADLINE]" loading="eager">
      </div>
    </div>
  </section>

  <!-- Benefits Section -->
  <section class="benefits">
    <div class="benefits-container">
      <h2>Por que escolher nossa solu√ß√£o?</h2>
      <div class="benefits-grid">
        [BENEFITS_CARDS]
      </div>
    </div>
  </section>

  <!-- Social Proof -->
  <section class="social-proof">
    <h3>[SOCIAL_PROOF_TITLE]</h3>
    <p>[SOCIAL_PROOF_TEXT]</p>
    <button class="cta-button" onclick="openModal()" style="margin-top: 2rem;">[CTA_TEXT]</button>
  </section>

  <!-- Footer -->
  <footer>
    <img src="https://catbytes.site/images/logo-desenvolvedora.webp" alt="CATBytes AI">
    <p>powered by CATBytes AI</p>
  </footer>

  <!-- Modal do Formul√°rio -->
  <div class="modal" id="leadModal">
    <div class="modal-content">
      <button class="modal-close" onclick="closeModal()">&times;</button>
      
      <!-- Destaque do E-book -->
      <div style="background: linear-gradient(135deg, ${theme.primary} 0%, ${theme.secondary} 100%); padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem; text-align: center;">
        <div style="font-size: 3rem; margin-bottom: 0.5rem;">üéÅ</div>
        <h3 style="color: white; margin-bottom: 0.5rem; font-size: 1.3rem;">B√¥nus Exclusivo!</h3>
        <p style="color: rgba(255,255,255,0.95); font-size: 0.95rem; margin: 0;">E-book GR√ÅTIS: 100 Dicas de Presen√ßa Online</p>
      </div>
      
      <h2>[EBOOK_HEADLINE]</h2>
      <p>[EBOOK_DESCRIPTION]</p>
      
      <form id="leadForm" onsubmit="submitForm(event)">
        <input type="text" class="honeypot" name="website" tabindex="-1">
        
        <label for="name">Nome completo *</label>
        <input type="text" id="name" name="name" required placeholder="Seu nome">
        
        <label for="email">E-mail * (enviaremos o e-book aqui)</label>
        <input type="email" id="email" name="email" required placeholder="seu@email.com">
        
        <label for="phone">Telefone (opcional)</label>
        <input type="tel" id="phone" name="phone" placeholder="(00) 00000-0000">
        
        <label for="message">Como podemos ajudar?</label>
        <textarea id="message" name="message" placeholder="Conte-nos sobre suas necessidades..."></textarea>
        
        <button type="submit">üéÅ Receber E-book Gr√°tis + Contato</button>
        
        <div class="security-badge">
          üîí Seus dados est√£o protegidos por criptografia SSL
        </div>
        <p style="text-align: center; font-size: 0.85rem; color: #718096; margin-top: 1rem;">
          Ao enviar, voc√™ receber√° o e-book por email instantaneamente!
        </p>
      </form>
    </div>
  </div>

  <script>
    function openModal() {
      document.getElementById('leadModal').classList.add('active');
      document.body.style.overflow = 'hidden';
    }
    
    function closeModal() {
      document.getElementById('leadModal').classList.remove('active');
      document.body.style.overflow = 'auto';
    }
    
    async function submitForm(e) {
      e.preventDefault();
      const form = e.target;
      const submitBtn = form.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      
      submitBtn.textContent = 'Enviando...';
      submitBtn.disabled = true;
      
      const formData = {
        name: form.name.value,
        email: form.email.value,
        phone: form.phone.value || '',
        message: form.message.value || '',
        honeypot: form.website.value,
        landingPageSlug: window.location.pathname.split('/').pop(),
        landingPageUrl: window.location.href,
        utm_source: new URLSearchParams(window.location.search).get('utm_source') || '',
        utm_medium: new URLSearchParams(window.location.search).get('utm_medium') || '',
        utm_campaign: new URLSearchParams(window.location.search).get('utm_campaign') || '',
        referrer: document.referrer
      };
      
      try {
        const response = await fetch('/api/landing-pages/submit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData)
        });
        
        if (response.ok) {
          alert('‚úÖ Sucesso!\\n\\nüìß Verifique seu email para receber:\\n- E-book "100 Dicas de Presen√ßa Online"\\n- Informa√ß√µes sobre nossos servi√ßos\\n\\nEntraremos em contato em breve!');
          form.reset();
          closeModal();
        } else {
          throw new Error('Erro ao enviar');
        }
      } catch (error) {
        alert('‚ùå Erro ao enviar. Tente novamente.');
      } finally {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
      }
    }
    
    // Fechar modal ao clicar fora
    document.getElementById('leadModal').addEventListener('click', function(e) {
      if (e.target === this) closeModal();
    });
    
    // Fechar modal com ESC
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') closeModal();
    });
  </script>
</body>
</html>

AGORA PREENCHA OS MARCADORES COM O CONTE√öDO:

AGORA PREENCHA OS MARCADORES COM O CONTE√öDO:

[HEADLINE] = ${content.headline}
[SUBHEADLINE] = ${content.subheadline}
[CTA_TEXT] = Baixar E-book Gr√°tis + ${cta_text}
[SOCIAL_PROOF_TITLE] = ${content.social_proof.split('.')[0]}
[SOCIAL_PROOF_TEXT] = ${content.social_proof}
[EBOOK_HEADLINE] = üéÅ B√¥nus Exclusivo: E-book Gr√°tis com 100 Dicas!
[EBOOK_DESCRIPTION] = Ao preencher o formul√°rio, voc√™ receber√° GR√ÅTIS nosso e-book "100 Dicas de Presen√ßa Online" + ${cta_text.toLowerCase()}

[BENEFITS_CARDS] = Crie 4 cards de benef√≠cios baseados em: ${content.benefits.join(', ')}
Cada card DEVE seguir este formato EXATO:
<div class="benefit-card">
  <div class="benefit-icon">[EMOJI_GRANDE]</div>
  <h3>[T√çTULO_CURTO]</h3>
  <p>[DESCRI√á√ÉO_2_LINHAS]</p>
</div>

Use emojis grandes e impactantes: üöÄ üíé ‚ö° üéØ üìà ‚ú® üî• üí∞

REGRAS CR√çTICAS:
1. Use EXATAMENTE o template fornecido
2. Modal agora promete E-BOOK + servi√ßo
3. Formul√°rio menciona envio do ebook por email
4. Design premium com gradientes modernos
5. Retorne HTML completo e v√°lido`
        }
      ],
      temperature: 0.7,
    })

    const htmlContent = htmlResponse.choices[0].message.content || ''

    // 4. Gerar slug √∫nico
    const slug = `${niche}-${Date.now()}`
    const title = content.headline.substring(0, 100)

    // 5. Salvar no banco
    const supabase = createClient()
    const { data: landingPage, error: dbError } = await supabase
      .from('landing_pages')
      .insert({
        title,
        slug,
        niche,
        problem,
        solution,
        cta_text,
        theme_color,
        headline: content.headline,
        subheadline: content.subheadline,
        benefits: content.benefits,
        hero_image_url: heroImageUrl,
        html_content: htmlContent,
        status: 'draft',
        deploy_status: 'pending',
      })
      .select()
      .single()

    if (dbError) {
      console.error('‚ùå Erro ao salvar no banco:', dbError)
      return NextResponse.json(
        { error: 'Erro ao salvar landing page', details: dbError.message },
        { status: 500 }
      )
    }

    console.log('‚úÖ Landing page gerada com sucesso!')

    return NextResponse.json({
      success: true,
      landingPage: {
        id: landingPage.id,
        slug: landingPage.slug,
        title: landingPage.title,
        headline: content.headline,
        subheadline: content.subheadline,
        heroImageUrl,
        previewUrl: `/lp/${slug}`, // Preview local
      },
      cost: {
        gpt4: 0.03, // ~$0.03 por p√°gina
        dalle3: 0.04, // $0.04 por imagem
        total: 0.07,
      }
    })

  } catch (error: any) {
    console.error('‚ùå Erro ao gerar landing page:', error)
    return NextResponse.json(
      { 
        error: 'Erro ao gerar landing page', 
        details: error.message,
        stack: process.env.NODE_ENV === 'development' ? error.stack : undefined
      },
      { status: 500 }
    )
  }
}
