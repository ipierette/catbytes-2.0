name: 'Cron Fallback - Blog Generation'

# Executa a cada 30 minutos das 13h √†s 14h30 BRT (16h √†s 17h30 UTC)
# Dias: Ter√ßa (2), Quinta (4), S√°bado (6), Domingo (0)
on:
  schedule:
    # Ter√ßa-feira √†s 16h, 16h30, 17h, 17h30 UTC (13h-14h30 BRT)
    - cron: '0,30 16,17 * * 2'
    # Quinta-feira √†s 16h, 16h30, 17h, 17h30 UTC  
    - cron: '0,30 16,17 * * 4'
    # S√°bado √†s 16h, 16h30, 17h, 17h30 UTC
    - cron: '0,30 16,17 * * 6'
    # Domingo √†s 16h, 16h30, 17h, 17h30 UTC
    - cron: '0,30 16,17 * * 0'
  
  # Permite execu√ß√£o manual do workflow
  workflow_dispatch:

jobs:
  check-and-generate:
    runs-on: ubuntu-latest
    
    steps:
      - name: Check if blog post was generated today
        id: check
        env:
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
          SITE_URL: https://www.catbytes.site
        run: |
          # Pegar data de hoje (YYYY-MM-DD)
          TODAY=$(date -u +"%Y-%m-%d")
          echo "Checking for blog post on date: $TODAY"
          
          # Buscar √∫ltimo post via API
          RESPONSE=$(curl -s "$SITE_URL/api/blog/posts?limit=1" \
            -H "Authorization: Bearer $CRON_SECRET")
          
          # Extrair data de cria√ß√£o do √∫ltimo post
          LAST_POST_DATE=$(echo "$RESPONSE" | jq -r '.posts[0].created_at' | cut -d'T' -f1)
          
          echo "Last post date: $LAST_POST_DATE"
          echo "Today's date: $TODAY"
          
          # Comparar datas
          if [ "$LAST_POST_DATE" = "$TODAY" ]; then
            echo "‚úÖ Blog post already generated today"
            echo "need_generation=false" >> $GITHUB_OUTPUT
          else
            echo "‚ùå No blog post found for today - will generate"
            echo "need_generation=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Generate blog post (fallback)
        if: steps.check.outputs.need_generation == 'true'
        env:
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
          SITE_URL: https://www.catbytes.site
        run: |
          echo "üöÄ Triggering blog generation via API..."
          
          RESPONSE=$(curl -X POST "$SITE_URL/api/blog/generate" \
            -H "Authorization: Bearer $CRON_SECRET" \
            -H "Content-Type: application/json" \
            -d '{}' \
            --max-time 180 \
            -w "\nHTTP_STATUS:%{http_code}")
          
          HTTP_STATUS=$(echo "$RESPONSE" | grep "HTTP_STATUS" | cut -d':' -f2)
          BODY=$(echo "$RESPONSE" | sed '/HTTP_STATUS/d')
          
          if [ "$HTTP_STATUS" = "200" ]; then
            echo "‚úÖ Blog post generated successfully!"
            
            # Extrair t√≠tulo (se tiver jq)
            TITLE=$(echo "$BODY" | jq -r '.post.title // "N/A"')
            SLUG=$(echo "$BODY" | jq -r '.post.slug // "N/A"')
            
            echo "üìù Title: $TITLE"
            echo "üîó Slug: $SLUG"
            echo "üì± Social promotion attempted"
          else
            echo "‚ùå Failed to generate blog post (HTTP $HTTP_STATUS)"
            echo "$BODY"
            exit 1
          fi
      
      - name: Send notification on success
        if: steps.check.outputs.need_generation == 'true'
        run: |
          echo "‚úÖ GitHub Actions fallback executed successfully"
          echo "Vercel Cron failed, but blog post was generated via fallback"
      
      - name: Send notification on failure
        if: failure()
        run: |
          echo "‚ùå Both Vercel Cron AND GitHub Actions fallback failed"
          echo "Manual intervention required"
